(function () {
	'use strict';
	
	var users = require('express').Router();
	var pg = require('pg');
	var bcrypt = require('bcrypt-nodejs');
	
	users
	.get('/', function (request, response) {
		pg.connect(function (err, client) {
			if (err) {
				console.error(err);
				response.status(500).end();
				return;
			} else {
				client.query({
					text: 'SELECT id, username FROM sysinfo.e_users ORDER BY id',
				}, function (err, result) {
					if (err) {
						console.error(err);
						response.status(500).end();
						return;
					} else {
						client.end();
						response.status(200).json(result.rows).end();
						return;
					}
				})
			}
		})
	})
	.post('/', function (request, response) {
		var user = {
			username: request.body.username,
			password: request.body.password
		}
		pg.connect(function (err, client) {
			if (err) {
				console.error('POST user:\n', err);
				response.status(500).end();
				return;
			} else {
				client.query({
					text: 'SELECT id FROM sysinfo.e_users WHERE username = $1',
					values: [user.username]
				}, function (err, result) {
					if (err) {
						console.error('SELECT user id:\n', err);
						response.status(500).end();
					} else {
						if (Number(result.rowCount === 1)) {
							console.log('Duplicate username');
							response.status(400).end();
							return;
						} else {
							var password = user.password;
							bcrypt.hash(password, null, null, function (err, hash) {
								user.password = hash;
								console.log('Password:\n', user.password);
								client.query({
									text: 'INSERT INTO sysinfo.e_users (username, password) VALUES ($1, $2) RETURNING id',
									values: [
										user.username,
										user.password
									]
								}, function (err, result) {
									if (err) {
										console.error('INSERT user:\n', err);
										response.status(500).end();
										return;
									} else {
										client.end();
										response.status(201).end();
										return;
									}
								})
							})
						}
					}
				})
			}
		})
	})
	
	module.exports = users;
})();