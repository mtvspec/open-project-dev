(function(){
	'use strict';
	
	var pg = require('pg');
	
	var chat = require('express')();
	var chatServer = require('http').Server(chat);
	var io = require('socket.io')(chatServer);

	chatServer.listen(10020);

	io.on('connection', function(socket){
		socket.on('login', function(data){
			console.log('Login:', data);
			pg.connect(function(err, client){
				if (err) {
					console.error('User post controller:\n', err);
					socket.emit('logIn', 'Error');
				} else {
					var user = {
						username: data.username,
						password: data.password
					}
					client.query({
						text: 'SELECT id FROM sysinfo.users WHERE username = $1 AND password = $2',
						values: [
							user.username,
							user.password
						]}, function(err, result){
							if (err) {
								console.error('SELECT user id:\n', err);
								socket.emit('logIn', 'Error');
							} else {
								if (Number(result.rowCount === 0)) {
									socket.emit('logIn', 'User not found');
									return;
								} else {
									var user = {
										id: result.rows[0].id
									}
									client.query({
										text: 'INSERT INTO sysinfo.sessions(user_id) VALUES ($1) RETURNING id',
										values: [user.id]
									}, function(err, result){
										if (err) {
											console.error('INSERT session:\n', err);
											socket.emit('logIn', 'Error');
										} else {
											client.end();
											socket.emit('logIn', result.rows[0]);	
										}
									})
								}
							}
					})
				}
			})
		})
		socket.on('message', function(data){
			pg.connect(function(err, client){
				if (err) {
					console.error('SAVE message:\n', err);
				}
				var message = {
					text: data.text
				}
				client.query({
					text: 'INSERT INTO e_messages(text) VALUES ($1) RETURNING id',
					values: [message.text]
				}, function(err, result){
					if (err) {
						console.error('INSERT message:\n', err);
					} else {
						client.end();	
					}
				})
			})
			io.emit('message', data);
		})
	});
	
	
	
	
	module.exports = chat;
})();